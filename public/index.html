<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoulFinance - Econom√≠a Emocional</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel para traducir JSX en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Estilos personalizados para animaciones -->
    <style>
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob {
            animation: blob 7s infinite;
        }
        .animation-delay-2000 {
            animation-delay: 2s;
        }
        .animation-delay-4000 {
            animation-delay: 4s;
        }
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }
        /* Ocultar barra de desplazamiento en chat pero permitir scroll */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>

    <!-- Import Map para gestionar librer√≠as -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Building2, Zap, Ghost, MessageCircle, ScanLine, 
            ShieldCheck, HeartPulse, Mic, 
            TrendingUp, AlertTriangle, Wind, Lock, Mail, User, Chrome,
            Send, Bot, X, Loader2
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInWithCustomToken, 
            onAuthStateChanged,
            signOut,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            orderBy,
            serverTimestamp 
        } from 'firebase/firestore';

        // ==========================================
        // CONFIGURACI√ìN DE SERVICIOS (backend)
        // ==========================================

        // 1. FIREBASE CONFIGURACI√ìN
        // Pega aqu√≠ la configuraci√≥n de tu consola de Firebase
        // Si est√°s probando en este entorno, usamos variables globales,
        // pero en tu proyecto real reemplaza el objeto 'fallbackConfig'.
        const fallbackConfig = {
             apiKey: "AIzaSyCSqdkDE__wdi2V9RwlD1Vv6QCyQEqTs5o",
             authDomain: "af-vision-finance.firebaseapp.com",
             projectId: "af-vision-finance",
             storageBucket: "af-vision-finance.firebasestorage.app",
             messagingSenderId: "226890046210",
             appId: "1:226890046210:web:52e5590a4fdeef6d24401b",
	     measurementId: "G-L70JYCZPJL"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : fallbackConfig;
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // 2. GOOGLE AI STUDIO (GEMINI) CONFIGURACI√ìN
        // Pega tu API Key de Google AI Studio aqu√≠ abajo.
        // NOTA: En producci√≥n, nunca expongas la key en el frontend directamente.
        // Usa Firebase Functions o un proxy. Para este prototipo est√° bien aqu√≠.
        const GOOGLE_AI_KEY = "AIzaSyDmR46hgEOW7QkHH8Rj5hn3FdHJZ43O2jE"; // <--- PEGA TU API KEY AQU√ç (empieza con AIza...)

        // ==========================================
        // L√ìGICA DE INTELIGENCIA ARTIFICIAL (GEMINI)
        // ==========================================
        
        const callFinancialAI = async (userMessage, financialContext, chatHistory) => {
            // Si no hay key configurada, devolvemos un mensaje simulado
            if (!GOOGLE_AI_KEY) {
                return new Promise(resolve => setTimeout(() => {
                    resolve("Hola. Para que pueda responderte de verdad, necesitas configurar la variable GOOGLE_AI_KEY en el c√≥digo. Por ahora soy un simulador: Veo que tus finanzas son interesantes.");
                }, 1000));
            }

            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GOOGLE_AI_KEY}`;

            // Construimos el "Prompt del Sistema" con los datos financieros del usuario
            const systemPrompt = `
                Eres "Soul", un asistente financiero emp√°tico e inteligente de la app SoulFinance.
                
                CONTEXTO FINANCIERO ACTUAL DEL USUARIO:
                - Presupuesto mensual: $${financialContext.budget}
                - Gastado hasta ahora: $${financialContext.totalSpent} (${financialContext.percentage.toFixed(1)}%)
                - Estado Emocional Financiero: ${financialContext.emotionalStatus}
                - Categor√≠a con m√°s gasto: ${financialContext.topCategory || 'Ninguna'}
                
                TU PERSONALIDAD:
                - No eres un robot aburrido. Eres un coach estilo "Jarvis" pero con inteligencia emocional.
                - Si el usuario est√° en "Rojo" (gast√≥ mucho), s√© calmado y prop√≥n soluciones zen.
                - Si el usuario va bien, s√© motivador y celebra sus logros.
                - Respuestas cortas, directas y √∫tiles (m√°ximo 3 frases).
                
                Responde a la pregunta del usuario bas√°ndote en estos datos.
            `;

            const contents = [
                { role: "user", parts: [{ text: systemPrompt }] }, // Contexto inicial
                ...chatHistory.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.text }]
                })),
                { role: "user", parts: [{ text: userMessage }] }
            ];

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: contents })
                });
                
                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);
                
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Error AI:", error);
                return "Lo siento, mi conexi√≥n neuronal est√° fallando (Error de API). Intenta de nuevo.";
            }
        };

        // --- CONSTANTES ---
        const CATEGORIES = [
            { id: 'food', name: 'Alimentaci√≥n', color: 'bg-emerald-500', icon: 'üçî' },
            { id: 'housing', name: 'Vivienda', color: 'bg-blue-500', icon: 'üè†' },
            { id: 'leisure', name: 'Ocio', color: 'bg-purple-500', icon: 'üéâ' },
            { id: 'transport', name: 'Transporte', color: 'bg-orange-500', icon: 'üöó' },
            { id: 'shopping', name: 'Compras', color: 'bg-pink-500', icon: 'üõçÔ∏è' },
        ];

        // --- COMPONENTES ---

        // 1. PANTALLA DE AUTENTICACI√ìN
        const AuthScreen = ({ onLogin }) => {
            const [isRegistering, setIsRegistering] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    if (isRegistering) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    setError(err.message.replace('Firebase:', '').trim());
                } finally {
                    setLoading(false);
                }
            };

            const handleGoogleLogin = async () => {
                try {
                    const provider = new GoogleAuthProvider();
                    await signInWithPopup(auth, provider);
                } catch (err) {
                    setError('Error al iniciar con Google. Verifica la configuraci√≥n en Firebase Console.');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-900 relative overflow-hidden">
                    <div className="absolute inset-0 z-0">
                        <div className="absolute top-0 left-0 w-96 h-96 bg-purple-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
                        <div className="absolute top-0 right-0 w-96 h-96 bg-blue-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>
                        <div className="absolute -bottom-32 left-20 w-96 h-96 bg-pink-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-4000"></div>
                    </div>

                    <div className="relative z-10 w-full max-w-md p-8 bg-white/10 backdrop-blur-xl border border-white/20 rounded-3xl shadow-2xl transform transition-all duration-500 m-4">
                        <div className="text-center mb-8">
                            <div className="mx-auto w-16 h-16 bg-gradient-to-tr from-cyan-400 to-blue-600 rounded-2xl flex items-center justify-center mb-4 shadow-lg shadow-blue-500/30">
                                <HeartPulse className="text-white w-8 h-8" />
                            </div>
                            <h1 className="text-3xl font-bold text-white tracking-tight">SoulFinance</h1>
                            <p className="text-blue-200 mt-2">Tu dinero, tus emociones, tu control.</p>
                        </div>

                        <form onSubmit={handleAuth} className="space-y-6">
                            <div className="space-y-4">
                                <div className="relative">
                                    <Mail className="absolute left-3 top-3.5 h-5 w-5 text-gray-400" />
                                    <input
                                        type="email"
                                        placeholder="Correo electr√≥nico"
                                        className="w-full pl-10 pr-4 py-3 bg-gray-800/50 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        required
                                    />
                                </div>
                                <div className="relative">
                                    <Lock className="absolute left-3 top-3.5 h-5 w-5 text-gray-400" />
                                    <input
                                        type="password"
                                        placeholder="Contrase√±a"
                                        className="w-full pl-10 pr-4 py-3 bg-gray-800/50 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        required
                                    />
                                </div>
                            </div>

                            {error && (
                                <div className="p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-200 text-sm flex items-center gap-2">
                                    <AlertTriangle className="w-4 h-4" /> {error}
                                </div>
                            )}

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-3.5 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-semibold rounded-xl shadow-lg shadow-purple-500/30 transform hover:scale-[1.02] transition-all disabled:opacity-50"
                            >
                                {loading ? 'Procesando...' : (isRegistering ? 'Crear Cuenta' : 'Iniciar Sesi√≥n')}
                            </button>
                        </form>

                        <div className="mt-6">
                            <div className="relative">
                                <div className="absolute inset-0 flex items-center">
                                    <div className="w-full border-t border-gray-600"></div>
                                </div>
                                <div className="relative flex justify-center text-sm">
                                    <span className="px-2 bg-transparent text-gray-400 bg-gray-900/50 backdrop-blur">O contin√∫a con</span>
                                </div>
                            </div>

                            <button 
                                onClick={handleGoogleLogin}
                                className="mt-4 w-full flex items-center justify-center gap-2 py-3 bg-white text-gray-900 font-medium rounded-xl hover:bg-gray-100 transition-colors shadow-lg"
                            >
                                <Chrome className="w-5 h-5 text-blue-600" />
                                Google
                            </button>
                        </div>

                        <div className="mt-8 text-center">
                            <p className="text-gray-400 text-sm">
                                {isRegistering ? '¬øYa tienes cuenta?' : '¬øA√∫n no tienes cuenta?'}
                                <button
                                    onClick={() => { setIsRegistering(!isRegistering); setError(''); }}
                                    className="ml-2 text-blue-400 hover:text-blue-300 font-medium focus:outline-none"
                                >
                                    {isRegistering ? 'Inicia sesi√≥n' : 'Reg√≠strate gratis'}
                                </button>
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. COMPONENTE DE CHAT IA
        const FinancialChat = ({ isOpen, onClose, financialData }) => {
            const [messages, setMessages] = useState([
                { role: 'model', text: 'Hola, soy Soul. He analizado tus finanzas. ¬øEn qu√© puedo orientarte hoy?' }
            ]);
            const [input, setInput] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => {
                if (scrollRef.current) {
                    scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                }
            }, [messages]);

            const handleSend = async () => {
                if (!input.trim()) return;
                
                const userMsg = input;
                setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
                setInput('');
                setIsTyping(true);

                // Llamada a la IA
                const aiResponse = await callFinancialAI(userMsg, financialData, messages);
                
                setMessages(prev => [...prev, { role: 'model', text: aiResponse }]);
                setIsTyping(false);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex flex-col bg-slate-50 animate-slide-up sm:max-w-md sm:mx-auto sm:right-0 sm:bottom-0 sm:h-[600px] sm:shadow-2xl sm:rounded-t-3xl sm:border sm:border-slate-200">
                    {/* Header Chat */}
                    <div className="bg-white border-b border-slate-100 p-4 flex items-center justify-between shadow-sm rounded-t-3xl">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-gradient-to-tr from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white shadow-lg">
                                <Bot size={20} />
                            </div>
                            <div>
                                <h3 className="font-bold text-slate-800">Soul AI</h3>
                                <p className="text-xs text-indigo-500 flex items-center gap-1">
                                    <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> En l√≠nea
                                </p>
                            </div>
                        </div>
                        <button onClick={onClose} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors">
                            <X size={20} className="text-slate-500" />
                        </button>
                    </div>

                    {/* √Årea de Mensajes */}
                    <div ref={scrollRef} className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 scrollbar-hide">
                        {messages.map((msg, idx) => (
                            <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[80%] p-3.5 rounded-2xl text-sm leading-relaxed shadow-sm ${
                                    msg.role === 'user' 
                                        ? 'bg-indigo-600 text-white rounded-br-none' 
                                        : 'bg-white text-slate-700 border border-slate-100 rounded-bl-none'
                                }`}>
                                    {msg.text}
                                </div>
                            </div>
                        ))}
                        {isTyping && (
                            <div className="flex justify-start">
                                <div className="bg-white border border-slate-100 p-3 rounded-2xl rounded-bl-none flex gap-1 items-center shadow-sm">
                                    <span className="w-2 h-2 bg-indigo-400 rounded-full animate-bounce"></span>
                                    <span className="w-2 h-2 bg-indigo-400 rounded-full animate-bounce delay-75"></span>
                                    <span className="w-2 h-2 bg-indigo-400 rounded-full animate-bounce delay-150"></span>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Input */}
                    <div className="p-4 bg-white border-t border-slate-100 pb-safe">
                        <div className="flex items-center gap-2 bg-slate-100 rounded-full px-4 py-2 border border-slate-200 focus-within:ring-2 focus-within:ring-indigo-500 focus-within:bg-white transition-all">
                            <input 
                                type="text" 
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                                placeholder="Pregunta sobre tus finanzas..."
                                className="flex-1 bg-transparent border-none focus:ring-0 text-sm py-2 text-slate-800 placeholder-slate-400"
                            />
                            <button 
                                onClick={handleSend}
                                disabled={!input.trim() || isTyping}
                                className="p-2 bg-indigo-600 rounded-full text-white hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-md"
                            >
                                <Send size={16} />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. MAIN APP
        function SoulFinanceApp() {
            const [user, setUser] = useState(null);
            const [loadingAuth, setLoadingAuth] = useState(true);
            
            // App State
            const [expenses, setExpenses] = useState([]);
            const [currentView, setCurrentView] = useState('city');
            const [zenMode, setZenMode] = useState(false);
            const [monthlyBudget, setMonthlyBudget] = useState(2000);
            const [chatOpen, setChatOpen] = useState(false); // Reemplaza voiceActive
            const [ghostMode, setGhostMode] = useState(false);
            const [showAddModal, setShowAddModal] = useState(false);

            // New Transaction State
            const [newAmount, setNewAmount] = useState('');
            const [newCategory, setNewCategory] = useState('food');
            const [newDesc, setNewDesc] = useState('');
            const [anxietyWarning, setAnxietyWarning] = useState(false);

            // --- AUTH & DATA LIFECYCLE ---
            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } catch (e) {
                            console.error("Error with custom token", e);
                        }
                    }
                };
                initAuth();
                
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoadingAuth(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                
                const q = query(
                    collection(db, 'artifacts', appId, 'users', user.uid, 'expenses'),
                    orderBy('createdAt', 'desc')
                );

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setExpenses(data);
                }, (error) => {
                    console.error("Error reading expenses:", error);
                });

                return () => unsubscribe();
            }, [user]);

            // --- CALCULATIONS & LOGIC ---
            const totalSpent = expenses.reduce((acc, curr) => acc + parseFloat(curr.amount || 0), 0);
            const spendingPercentage = (totalSpent / monthlyBudget) * 100;

            const getEmotionalStatus = () => {
                if (spendingPercentage > 100) return { color: 'bg-red-600', text: 'Riesgo Cr√≠tico', mood: 'üò°' };
                if (spendingPercentage > 85) return { color: 'bg-orange-500', text: 'Estr√©s Financiero', mood: 'üò∞' };
                if (spendingPercentage > 60) return { color: 'bg-yellow-400', text: 'Cuidado Impulsivo', mood: 'üòê' };
                return { color: 'bg-emerald-500', text: 'Finanzas Conscientes', mood: 'üòå' };
            };

            const status = getEmotionalStatus();

            const categoryData = useMemo(() => {
                const data = {};
                CATEGORIES.forEach(c => data[c.id] = { ...c, total: 0, count: 0 });
                
                expenses.forEach(e => {
                    if (data[e.category]) {
                        data[e.category].total += parseFloat(e.amount);
                        data[e.category].count += 1;
                    }
                });
                return Object.values(data);
            }, [expenses]);

            // Preparar datos para la IA
            const getFinancialContext = () => {
                const topCategory = categoryData.sort((a, b) => b.total - a.total)[0];
                return {
                    budget: monthlyBudget,
                    totalSpent: totalSpent,
                    percentage: spendingPercentage,
                    emotionalStatus: status.text,
                    topCategory: topCategory && topCategory.total > 0 ? topCategory.name : null
                };
            };

            // --- HANDLERS ---
            const handleAddExpense = async () => {
                if (!newAmount || !user) return;

                const isImpulsive = (newCategory === 'shopping' || newCategory === 'leisure') && parseFloat(newAmount) > 50;
                if (isImpulsive && !anxietyWarning) {
                    setAnxietyWarning(true);
                    return; 
                }

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'expenses'), {
                        amount: parseFloat(newAmount),
                        category: newCategory,
                        description: newDesc || 'Gasto r√°pido',
                        createdAt: serverTimestamp(),
                        isGhost: Math.random() > 0.8
                    });
                    setShowAddModal(false);
                    setNewAmount('');
                    setNewDesc('');
                    setAnxietyWarning(false);
                    
                    if (spendingPercentage > 95) {
                        setZenMode(true);
                    }
                } catch (e) {
                    console.error("Error adding expense", e);
                }
            };

            const toggleZenMode = () => setZenMode(!zenMode);

            // --- RENDER ---
            if (loadingAuth) return <div className="min-h-screen bg-black flex items-center justify-center text-white"><Loader2 className="animate-spin mr-2" /> Cargando SoulFinance...</div>;
            if (!user) return <AuthScreen />;

            if (zenMode) {
                return (
                    <div className="min-h-screen bg-stone-900 text-stone-200 flex flex-col items-center justify-center p-8 transition-colors duration-1000">
                        <Wind className="w-24 h-24 text-teal-500 animate-pulse mb-8" />
                        <h1 className="text-4xl font-serif mb-4">Modo Zen Activado</h1>
                        <p className="text-center max-w-md text-lg mb-8 opacity-80 leading-relaxed">
                            Tus finanzas han alcanzado un punto de estr√©s. Respira. 
                            Hemos pausado las notificaciones de gasto. 
                            Tu microplan de 48h: No gastar en nada que no sea alimentaci√≥n b√°sica.
                        </p>
                        <div className="grid grid-cols-2 gap-4 mb-8">
                            <div className="p-4 bg-stone-800 rounded-lg border border-stone-700">
                                <h3 className="font-bold text-teal-400">Medita</h3>
                                <p className="text-sm">Antes de comprar, cuenta hasta 10.</p>
                            </div>
                            <div className="p-4 bg-stone-800 rounded-lg border border-stone-700">
                                <h3 className="font-bold text-teal-400">Revisa</h3>
                                <p className="text-sm">¬øRealmente lo necesitas hoy?</p>
                            </div>
                        </div>
                        <button 
                            onClick={toggleZenMode}
                            className="px-8 py-3 bg-teal-900/50 border border-teal-700 hover:bg-teal-900 rounded-full transition-all"
                        >
                            Volver a la realidad
                        </button>
                    </div>
                );
            }

            return (
                <div className={`min-h-screen transition-colors duration-500 pb-20 font-sans
                    ${status.color === 'bg-red-600' ? 'bg-gray-900' : 'bg-slate-50'} text-slate-900`}>
                    
                    {/* 1. HEADER & EMOTIONAL BAR */}
                    <header className={`sticky top-0 z-50 ${status.color} text-white shadow-lg transition-colors duration-700`}>
                        <div className="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <span className="text-2xl">{status.mood}</span>
                                <div>
                                    <h1 className="font-bold text-sm leading-tight">{status.text}</h1>
                                    <p className="text-xs opacity-90">{Math.round(spendingPercentage)}% del presupuesto</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <button onClick={() => setGhostMode(!ghostMode)} className={`p-2 rounded-full ${ghostMode ? 'bg-white text-gray-900' : 'bg-white/20'}`}>
                                    <Ghost size={18} />
                                </button>
                                <button onClick={() => signOut(auth)} className="p-2 bg-white/20 rounded-full hover:bg-white/30">
                                    <User size={18} />
                                </button>
                            </div>
                        </div>
                        <div className="w-full h-1 bg-black/20">
                            <div 
                                className="h-full bg-white/90 transition-all duration-1000 ease-out"
                                style={{ width: `${Math.min(spendingPercentage, 100)}%` }}
                            />
                        </div>
                    </header>

                    <main className="max-w-md mx-auto p-4 space-y-6">

                        {/* 2. CITY MAP */}
                        {currentView === 'city' && (
                            <div className="relative min-h-[300px] perspective-1000">
                                <div className="flex justify-between items-end mb-4">
                                    <h2 className="text-xl font-bold text-slate-700 flex items-center gap-2">
                                        <Building2 className="text-indigo-500" /> Mapa Financiero
                                    </h2>
                                    <div className="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">Vista 4D</div>
                                </div>

                                <div className="grid grid-cols-3 gap-4 h-64 items-end p-4 bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden relative">
                                    <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20"></div>
                                    <div className="absolute inset-0 bg-grid-slate-100 [mask-image:linear-gradient(0deg,white,transparent)]" />
                                    
                                    {categoryData.map((cat) => {
                                        const maxSpend = Math.max(...categoryData.map(c => c.total), 1);
                                        const heightPercent = (cat.total / maxSpend) * 100;
                                        const isRisk = cat.total > (monthlyBudget / 5); 

                                        return (
                                            <div key={cat.id} className="flex flex-col items-center justify-end h-full z-10 group cursor-pointer hover:scale-105 transition-transform">
                                                <div 
                                                    className={`w-full relative rounded-t-lg transition-all duration-1000 ${isRisk ? 'animate-pulse' : ''}`}
                                                    style={{ height: `${Math.max(heightPercent, 10)}%` }}
                                                >
                                                    <div className={`absolute inset-0 opacity-80 ${cat.color} rounded-t-lg shadow-lg`}></div>
                                                    <div className="absolute inset-2 grid grid-cols-2 gap-1 opacity-30">
                                                        <div className="bg-white rounded-sm h-2 w-2"></div>
                                                        <div className="bg-white rounded-sm h-2 w-2"></div>
                                                    </div>
                                                </div>
                                                <span className="mt-2 text-xs font-bold text-slate-600">{cat.name}</span>
                                                <span className="text-[10px] text-slate-400">${cat.total}</span>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* 3. DIGITAL TWIN */}
                        {currentView === 'twin' && (
                            <div className="bg-white p-6 rounded-3xl shadow-xl border border-purple-100">
                                <h2 className="text-xl font-bold text-purple-900 mb-4 flex items-center gap-2">
                                    <Zap className="text-purple-500" /> Gemelo Digital
                                </h2>
                                <div className="space-y-6">
                                    <div className="bg-slate-50 p-4 rounded-xl">
                                        <p className="text-sm text-slate-500 mb-2">Proyecci√≥n a 30 d√≠as:</p>
                                        <div className="flex justify-between items-end h-24 gap-2">
                                            <div className="w-1/3 bg-gray-200 rounded-t-lg h-16 flex flex-col justify-end p-2 text-xs text-center"><span>Actual</span></div>
                                            <div className={`w-1/3 rounded-t-lg h-full flex flex-col justify-end p-2 text-xs text-center text-white shadow-lg ${spendingPercentage > 100 ? 'bg-red-500' : 'bg-emerald-500'}`}><span>Futuro</span></div>
                                            <div className="w-1/3 bg-blue-100 rounded-t-lg h-20 flex flex-col justify-end p-2 text-xs text-center border-2 border-dashed border-blue-300"><span>Meta</span></div>
                                        </div>
                                    </div>
                                    <div className="space-y-3">
                                        <h3 className="font-semibold text-sm text-slate-700">Simular impacto de compra:</h3>
                                        <input type="range" className="w-full accent-purple-600" min="0" max="500" />
                                        <div className="p-3 bg-purple-50 border border-purple-100 rounded-lg text-sm text-purple-800">
                                            <span className="font-bold">IA Predictiva:</span> Si gastas $200 hoy, entrar√°s en zona roja el d√≠a 25.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* STATS & BADGES */}
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                                <div className="flex items-center gap-2 mb-2 text-slate-500">
                                    <TrendingUp size={16} /> <span className="text-xs font-bold uppercase">Vs Mes Pasado</span>
                                </div>
                                <p className="text-2xl font-bold text-emerald-500">-12%</p>
                            </div>
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-1 bg-yellow-400 text-[10px] font-bold rounded-bl-lg">NUEVO</div>
                                <div className="flex items-center gap-2 mb-2 text-slate-500">
                                    <ShieldCheck size={16} /> <span className="text-xs font-bold uppercase">Medallas</span>
                                </div>
                                <div className="flex justify-center text-3xl">ü¶Å</div>
                                <p className="text-center text-xs font-bold mt-1 text-slate-700">Fiera del Ahorro</p>
                            </div>
                        </div>

                        {/* GHOST MODE */}
                        {ghostMode && (
                            <div className="bg-gray-900 text-gray-300 p-4 rounded-2xl border border-gray-700 animate-fade-in">
                                <h3 className="flex items-center gap-2 font-bold mb-3 text-gray-100">
                                    <Ghost className="text-purple-400" /> Modo Fantasma
                                </h3>
                                <ul className="space-y-2 text-sm">
                                    {expenses.filter(e => e.isGhost).map(e => (
                                        <li key={e.id} className="flex justify-between items-center p-2 bg-gray-800 rounded">
                                            <span className="opacity-70">{e.description}</span>
                                            <span className="text-red-400">-${e.amount}</span>
                                        </li>
                                    ))}
                                    {expenses.filter(e => e.isGhost).length === 0 && <p className="text-xs text-gray-500">Nada por aqu√≠...</p>}
                                </ul>
                            </div>
                        )}

                    </main>

                    {/* FAB ADD BUTTON */}
                    <button 
                        onClick={() => setShowAddModal(true)}
                        className="fixed bottom-24 right-6 w-14 h-14 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-full text-white shadow-xl shadow-blue-500/40 flex items-center justify-center hover:scale-110 transition-transform z-30"
                    >
                        <span className="text-3xl font-light mb-1">+</span>
                    </button>

                    {/* BOTTOM NAV */}
                    <nav className="fixed bottom-0 w-full bg-white/90 backdrop-blur-lg border-t border-slate-200 pb-safe pt-2 px-6 flex justify-between items-center z-40 text-xs font-medium text-slate-400">
                        <button onClick={() => setCurrentView('city')} className={`flex flex-col items-center gap-1 p-2 ${currentView === 'city' ? 'text-blue-600' : ''}`}><Building2 size={20} /><span>Ciudad</span></button>
                        <button onClick={() => setCurrentView('twin')} className={`flex flex-col items-center gap-1 p-2 ${currentView === 'twin' ? 'text-purple-600' : ''}`}><User size={20} /><span>Gemelo</span></button>
                        
                        {/* BOT√ìN CHAT IA CENTRAL */}
                        <button 
                            onClick={() => setChatOpen(true)}
                            className="flex flex-col items-center gap-1 p-2 -mt-8 bg-white border border-slate-100 rounded-full shadow-lg text-indigo-600 hover:scale-105 transition-transform"
                        >
                            <div className="bg-gradient-to-tr from-indigo-500 to-purple-600 p-3 rounded-full text-white shadow-md">
                                <MessageCircle size={24} />
                            </div>
                        </button>
                        
                        <button onClick={() => alert("Scanner")} className="flex flex-col items-center gap-1 p-2"><ScanLine size={20} /><span>Ticket</span></button>
                        <button onClick={toggleZenMode} className="flex flex-col items-center gap-1 p-2 hover:text-teal-600"><Wind size={20} /><span>Zen</span></button>
                    </nav>

                    {/* ADD MODAL */}
                    {showAddModal && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 animate-slide-up shadow-2xl">
                                <h3 className="text-lg font-bold text-slate-800 mb-4">Nuevo Movimiento</h3>
                                
                                {anxietyWarning ? (
                                    <div className="bg-orange-50 border border-orange-200 rounded-xl p-4 mb-4 animate-pulse">
                                        <div className="flex items-center gap-2 text-orange-600 font-bold mb-2">
                                            <AlertTriangle size={18} /> Compra por Ansiedad
                                        </div>
                                        <p className="text-sm text-orange-800 mb-3">Gasto inusual detectado. ¬øNecesidad o emoci√≥n?</p>
                                        <div className="flex gap-2">
                                            <button onClick={() => setAnxietyWarning(false)} className="flex-1 py-2 bg-orange-200 text-orange-900 rounded-lg text-sm font-bold">Comprar</button>
                                            <button onClick={() => setShowAddModal(false)} className="flex-1 py-2 bg-emerald-500 text-white rounded-lg text-sm font-bold">Ahorrar</button>
                                        </div>
                                    </div>
                                ) : (
                                    <>
                                        <div className="mb-4">
                                            <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Monto</label>
                                            <input type="number" value={newAmount} onChange={(e) => setNewAmount(e.target.value)} className="w-full bg-slate-50 rounded-2xl py-3 px-4 text-2xl font-bold text-slate-800 focus:ring-2 focus:ring-blue-500" placeholder="0.00" autoFocus />
                                        </div>
                                        <div className="mb-4">
                                            <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Categor√≠a</label>
                                            <div className="grid grid-cols-5 gap-2">
                                                {CATEGORIES.map(cat => (
                                                    <button key={cat.id} onClick={() => setNewCategory(cat.id)} className={`flex flex-col items-center p-2 rounded-xl border-2 ${newCategory === cat.id ? `border-${cat.color.split('-')[1]}-500 bg-slate-50` : 'border-transparent'}`}>
                                                        <span className="text-xl">{cat.icon}</span>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="flex gap-3">
                                            <button onClick={() => setShowAddModal(false)} className="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl">Cancelar</button>
                                            <button onClick={handleAddExpense} className="flex-1 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold rounded-xl">Guardar</button>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    )}

                    {/* COMPONENTE DE CHAT */}
                    <FinancialChat 
                        isOpen={chatOpen} 
                        onClose={() => setChatOpen(false)} 
                        financialData={getFinancialContext()}
                    />
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<SoulFinanceApp />);
    </script>
</body>
</html>